{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
    /* Переключатель - коробка вокруг ползунка */
.switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

/* Скрыть флажок HTML по умолчанию */
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

/* Ползунок */
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .slider {
  background-color: #2196F3;
}

input:focus + .slider {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
  -webkit-transform: translateX(26px);
  -ms-transform: translateX(26px);
  transform: translateX(26px);
}

/* Закругленные ползунки */
.slider.round {
  border-radius: 34px;
}

.slider.round:before {
  border-radius: 50%;
}
</style>


<h1>Всякое для разработки</h1>

<p>Выйти и друзья в настройки</p>
<p>Включить темную тему: 
    <label class="switch">
        <input type="checkbox" id="themeStyle" onclick="changeTheme()">
        <span class="slider round"></span>
    </label>
</p>


<script>
let changeTheme = function() {
  if (themeStyle.checked == true) {
    globalStyle.classList.remove(globalStyle.classList[1])
    globalStyle.classList.add('black-theme')
  } else if (themeStyle.checked == false) {
    globalStyle.classList.remove(globalStyle.classList[1])
    globalStyle.classList.add('white-theme')
  } 
}
</script>

<!-- Air-DatePicker -->
<!-- <input type="text" class="datepicker-here form-control" id="datepicker">
<script>
// https://codepen.io/ankithingarajiya/pen/jjOxMo
$('#datepicker').datepicker({
    language: 'ru',
    minDate: new Date(),
    dateFormat: 'dd.mm.yyyy',
    // isMobile: true,
    autoClose: true,
    date: new Date(),
})
.data('datepicker')
.selectDate(new Date())
</script> -->

<hr>

<button id="testPublic">Получить публичную информацию</button>
<button id="testSecret">Получить секретную информацию</button>

<hr>

<form method="post" enctype="multipart/form-data" id="form1">
  {% csrf_token %}
  <label for="img_input">Выберите 1 файл:</label>
  <input type="file" id="img_input" name="file" required>
  <button type="submit">Отправить</button>
</form>

<form method="post" enctype="multipart/form-data" id="form2">
  <label for="img_input2">Выберите несколько картинок:</label>
  <input type="file" id="img_input2" name="files" multiple required accept="image/jpeg, image/png, image/webp">
  <button type="submit">Отправить</button>
</form>

<script>
  const domen = "http://127.0.0.1:8002/"
  const url1 = "//:8002/api/test-upload"
  const form1 = document.getElementById('form1')
  const form2 = document.getElementById('form2')
  
  const AJAX = {
    send: async function(url, options) { // формируется запрос на url с options
        try {
            let response = await fetch(url, options)
            let data = await this.check_status(response).catch(this.raise_error)

            if (data) {
                let jsonData = this.to_json(data)
                return jsonData
            }

        } catch (error) {
            console.log('Error: неизвестная ошибка catch')
            // console.log(error.message)
        }

    },
    check_status: function(response) { // проверка статус кода запроса
        if (!response.ok) {
            if (response.status==401) {
                console.log("Error 401: credentials not valid")
            }
            if (response.status==403) {
                console.log("Error 403: no access rights")
            }
            if (![401, 403].includes(response.status)) {  // если не
                console.log(`Error ${response.status}`)
            }
            return Promise.reject(new Error(response.statusText))
        }
        return Promise.resolve(response)
    },
    to_json: function(response) { // десериализация строки в json объект
        return response.json()
    },
    raise_error: function(error) { // обработка ошибок (400е и 500е статусы не являются ошибками)
        // console.log('Error: raise_error. ', error)
    },
}

  const sendForm = async function(event) {  // отправить 1 картинку на сервер 
    event.preventDefault()




    // const formData = new FormData(form1)  // FormData автоматически формирует корректный multipart/form-data‑запрос
    // FormData Автоматически собирает все поля формы, включая файл. Для файла сохраняются:
    // - имя (name из <input>),
    // - оригинальное имя файла (filename в запросе),
    // - MIME‑тип (type),
    // - содержимое.
    // FormData также сам устанавливает Content-Type: multipart/form-data; boundary=... с корректным boundary

    // const url = "http://127.0.0.1:8002/api/test-upload"
    // const options = {
    //     method: 'POST',
    //     credentials: 'include',
    //     body: formData,
    //     // "X-CSRFToken": csrftoken,
    //     // mode: 'no-cors',
    // }

    // console.log(csrftoken)
    // try {
    //   const response = await fetch(url, options)

    //   if (response.ok) {
    //     const result = await response.json();
    //     console.log('Файл загружен:', result);
    //   } else {
    //     console.error('Ошибка сервера:', response.status);
    //   }
    // } catch (error) {
    //   console.error('Ошибка сети:', error);
    // }

    const formData = new FormData(form1) 
    // let data = {
    //     'title': form1.img_input.name,
    //     'file': form1.img_input
    // }
    const url = 'http://127.0.0.1:8002/api/test-upload/'
    const options = {
        method: 'POST',
        // headers: {
        //     'Content-Type': 'multipart/form-data',
        // },
        credentials: 'include',
        body: formData,
        // "X-CSRFToken": csrftoken,
        // mode: 'no-cors',
    }
    
    let response = await AJAX.send(url, options)
    console.log(response)

    if (response === undefined) {
        console.log(`Error: неопознанная ошибка`)
    } else {
        console.log(`запрос отправлен`)
    }

  }
  form1.addEventListener('submit', sendForm)

  const checkImgSize = function(files) {  // Проверка размеров файлов

    const maxSize = 5 * 1024 * 1024  // 5 MB
    const maxTotalSize = maxSize * 10

    // Проверка каждого файла
    let totalSize = 0
    for (const file of files) {
        if (file.size > maxSize) {
            console.error(`Файл "${file.name}" превышает лимит ${maxSize / 1024 / 1024} MB`)
            alert(`Файл "${file.name}" слишком большой. Максимум: 5 MB`)
            return false
        }
        totalSize += file.size
    }
    
    // Проверка общего размера
    if (totalSize > maxTotalSize) {
        console.error(`Общий размер файлов превышает ${maxTotalSize / 1024 / 1024} MB`)
        alert(`Общий размер файлов слишком большой. Максимум: 20 MB`)
        return false
    }
    return true
  }

  const sendForm2 = async function(event) {  // отправить 1 картинку на сервер 
    event.preventDefault()

    const files = form2.img_input2.files
    if (!checkImgSize(files)) return

    const formData = new FormData(form2) 
    const url = 'http://127.0.0.1:8002/api/test-upload/'
    const options = {
        method: 'POST',
        credentials: 'include',
        body: formData,
    }
    
    await fetch(url, options)
      .then(response => {
        if (!response.ok) {
          throw new Error(`Error: ошибка отправки картинки ${response.status}`)
        }
        return response.json()
      })
      .then(data => {
        // обновить данные страницы
        console.log('Данные отправлены', data)
      })
      .catch(error => {
        console.log('Error', error)
      })

  }
  form2.addEventListener('submit', sendForm2)

</script>

<hr>



<script type="module" src="{% static 'js/other.js' %}"></script>

{% endblock content %}