# Редирект с HTTP на HTTPS
server {
    listen 80;  # Порт HTTP
    server_name daystream.ru;  # ЗАМЕНИТЬ на ваш реальный домен
    return 301 https://$server_name$request_uri;  # Постоянный редирект на HTTPS
}

# Production - HTTPS с редиректом с HTTP
server {
    listen 443 ssl http2;  # Порт HTTPS с поддержкой HTTP/2 для производительности
    server_name daystream.ru;  # ЗАМЕНИТЬ на реальный домен
    
    # SSL сертификаты (нужно получить от Let's Encrypt или другого CA)
    ssl_certificate /etc/nginx/ssl/cert.pem;  # Публичный сертификат
    ssl_certificate_key /etc/nginx/ssl/key.pem;  # Приватный ключ
    
    # Настройки SSL протоколов и шифров для безопасности
    ssl_protocols TLSv1.2 TLSv1.3;  # Только современные протоколы
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256;  # Надежные шифры
    ssl_prefer_server_ciphers off;  # Позволить клиенту выбирать шифр
    ssl_session_cache shared:SSL:10m;  # Кэш SSL сессий для производительности
    ssl_session_timeout 10m;  # Время жизни кэша сессий
    
    # Security headers для браузера (дополнительная защита)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;  # HSTS - заставляет браузер использовать только HTTPS
    add_header X-Frame-Options "DENY" always;  # Защита от clickjacking (запрещает embedding в iframe)
    add_header X-Content-Type-Options "nosniff" always;  # Защита от MIME-атак
    add_header X-XSS-Protection "1; mode=block" always;  # Включить XSS фильтр браузера
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;  # Политика рефереров

    # Проксирование на frontend Django приложение
    location / {
        proxy_pass http://front:8000;  # Передача запросов на frontend контейнер
        proxy_set_header Host $http_host;  # Критически важно для редиректов (содержит домен с портом)
        proxy_set_header X-Real-IP $remote_addr;  # Реальный IP клиента
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # Цепочка прокси
        proxy_set_header X-Forwarded-Proto https;  # Важно: https для Django security
        proxy_set_header X-Forwarded-Host $http_host;  # Важно: для правильных URL в редиректах
        proxy_set_header X-Forwarded-Port 443;  # Важно: 443 для правильных URL
    }

    # Проксирование на authserver API (аутентификация)
    location /auth/ {
        proxy_pass http://authserver:8000;  # Передача запросов на authserver контейнер
        proxy_set_header Host $host;  # Достаточно $host (нет генерации абсолютных URL)
        proxy_set_header X-Real-IP $remote_addr;  # Реальный IP клиента
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # Цепочка прокси
        proxy_set_header X-Forwarded-Proto https;  # Важно: https для Django security
        proxy_set_header X-Forwarded-Host $host;  # Достаточно $host для API
        proxy_set_header X-Forwarded-Port 443;  # Важно: 443 для правильных URL
    }

    # Проксирование на backend API (основная логика)
    location /api/ {
        proxy_pass http://back:8000;  # Передача запросов на backend контейнер
        proxy_set_header Host $http_host;  # Критически важно для генерации URL медиафайлов
        proxy_set_header X-Real-IP $remote_addr;  # Реальный IP клиента
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # Цепочка прокси
        proxy_set_header X-Forwarded-Proto https;  # Важно: https для Django security
        proxy_set_header X-Forwarded-Host $http_host;  # Критически важно для генерации ссылок на картинки
        proxy_set_header X-Forwarded-Port 443;  # Важно: 443 для правильных URL
    }

    # Статические файлы Django (CSS, JS, изображения)
    location /static/ {
        alias /var/www/static/;  # Путь к статическим файлам в контейнере
        expires 30d;  # Кэширование на 30 дней для производительности
    }

    # Медиа файлы пользователей (загруженные изображения, документы)
    location /media/ {
        alias /var/www/media/;  # Путь к медиа файлам в контейнере
    }
}
