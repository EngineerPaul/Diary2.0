#!/bin/bash

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
# –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ API Let's Encrypt, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç HTTP –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏, –ø–æ—Ç–æ–º—É —á—Ç–æ –∫–ª—é—á–∏ —É–∂–µ –ø–æ–ª—É—á–µ–Ω—ã —Ä–∞–Ω–µ–µ
# –í—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (hot-reload nginx)

set -e  # –í—ã—Ö–æ–¥ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

echo "=== SSL Factory: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ ==="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "ssl-compose.yaml" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ ssl-factory"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .env —Ñ–∞–π–ª–∞
if [ ! -f "./certbot/.env" ]; then
    echo "‚ùå –§–∞–π–ª ./certbot/.env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env
source ./certbot/.env

if [ -z "$DOMAIN" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: DOMAIN –Ω–µ —É–∫–∞–∑–∞–Ω –≤ certbot/.env"
    exit 1
fi

echo "üåê –î–æ–º–µ–Ω: $DOMAIN"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
if [ ! -f "../nginx/ssl/cert.pem" ]; then
    echo "‚ùå –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É:"
    echo "   ./scripts/setup-ssl.sh"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."
EXPIRY_DATE=$(openssl x509 -in ../nginx/ssl/cert.pem -noout -enddate | cut -d= -f2)
EXPIRY_EPOCH=$(date -d "$EXPIRY_DATE" +%s)
NOW_EPOCH=$(date +%s)
DAYS_LEFT=$(( ($EXPIRY_EPOCH - $NOW_EPOCH) / 86400 ))

echo "üìÖ –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: $EXPIRY_DATE"
echo "‚è∞ –û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π: $DAYS_LEFT"
echo ""

# –ï—Å–ª–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –±–æ–ª–µ–µ 14 –¥–Ω–µ–π, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
if [ $DAYS_LEFT -gt 14 ]; then
    echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –µ—â–µ $DAYS_LEFT –¥–Ω–µ–π)"
    exit 0
fi

echo "üîÑ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ $DAYS_LEFT –¥–Ω–µ–π. –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ..."
echo ""

# –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Ç–µ–∫—É—â–∏—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
echo "üíæ –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é..."
BACKUP_DIR="../nginx/ssl/backup/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"
cp ../nginx/ssl/* "$BACKUP_DIR/"
echo "‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: $BACKUP_DIR"
echo ""

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5)
ls -t ../nginx/ssl/backup/ 2>/dev/null | tail -n +6 | xargs -r rm -rf

# –ó–∞–ø—É—Å–∫–∞–µ–º SSL Factory –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
echo "ÔøΩ –ó–∞–≥—Ä—É–∂–∞–µ–º Docker –æ–±—Ä–∞–∑—ã..."
docker-compose -f ssl-compose.yaml pull

echo "ÔøΩ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker-compose -f ssl-compose.yaml up -d

# –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
echo "‚è≥ –û–∂–∏–¥–∞–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
MAX_START_WAIT=30  # 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
START_TIME=0

while [ $START_TIME -lt $MAX_START_WAIT ]; do
    if docker-compose -f ssl-compose.yaml ps | grep -q "Up"; then
        echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã –∑–∞ ${START_TIME} —Å–µ–∫—É–Ω–¥"
        break
    fi
    
    if [ $START_TIME -eq 0 ]; then
        echo -n "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã"
    else
        echo -n ". "
    fi
    
    sleep 2
    START_TIME=$((START_TIME + 2))
done

if [ $START_TIME -ge $MAX_START_WAIT ]; then
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞: –°–µ—Ä–≤–∏—Å—ã –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å –∑–∞ ${MAX_START_WAIT} —Å–µ–∫—É–Ω–¥"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: docker-compose -f ssl-compose.yaml logs"
    echo "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "- –ü—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π"
    echo "- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤ —Å–∏—Å—Ç–µ–º—ã"
    echo "- –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø–æ—Ä—Ç–æ–≤"
    echo "–ü–æ—Å–ª–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∑–∞–Ω–æ–≤–æ"
    docker-compose -f ssl-compose.yaml down
    exit 1
fi

# –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
echo "üîë –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã..."
# –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–∂–µ –∑–∞–ø—É—â–µ–Ω—ã, –∂–¥–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è entrypoint certbot
echo "‚è≥ –û–∂–∏–¥–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è entrypoint certbot..."
MAX_CERTBOT_WAIT=120  # 2 –º–∏–Ω—É—Ç—ã –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ certbot
CERTBOT_TIME=0

while [ $CERTBOT_TIME -lt $MAX_CERTBOT_WAIT ]; do
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –ª–∏ certbot –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (certbot –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è)
    if ! docker-compose -f ssl-compose.yaml ps | grep -q "certbot.*Up"; then
        echo "‚úÖ Certbot –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É –∑–∞ ${CERTBOT_TIME} —Å–µ–∫—É–Ω–¥"
        break
    fi
    
    if [ $CERTBOT_TIME -eq 0 ]; then
        echo -n "üîë –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è certbot"
    elif [ $CERTBOT_TIME -eq 30 ]; then
        echo ""
        echo "‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è..."
        echo -n "üîë –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ"
    else
        echo -n ". "
    fi
    
    sleep 3
    CERTBOT_TIME=$((CERTBOT_TIME + 3))
done

if [ $CERTBOT_TIME -ge $MAX_CERTBOT_WAIT ]; then
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞: Certbot –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É –∑–∞ ${MAX_CERTBOT_WAIT} —Å–µ–∫—É–Ω–¥"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: docker-compose -f ssl-compose.yaml logs certbot"
    echo "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "- –ü—Ä–æ–±–ª–µ–º—ã —Å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é –¥–æ–º–µ–Ω–∞"
    echo "- –ü—Ä–æ–±–ª–µ–º—ã —Å Let's Encrypt"
    echo "–ü–æ—Å–ª–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∑–∞–Ω–æ–≤–æ"
    docker-compose -f ssl-compose.yaml down
    exit 1
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º SSL Factory
docker-compose -f ssl-compose.yaml down

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–±–Ω–æ–≤–∏–ª–∏—Å—å –ª–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è..."
if [ "../nginx/ssl/cert.pem" -nt "$BACKUP_DIR/cert.pem" ]; then
    echo "‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–æ–≤—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞—Ö
    echo "üìÑ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–æ–≤—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞—Ö:"
    openssl x509 -in ../nginx/ssl/cert.pem -noout -dates
    echo ""
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º hot-reload –æ—Å–Ω–æ–≤–Ω–æ–≥–æ nginx –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
    echo "üîÑ –í—ã–ø–æ–ª–Ω—è–µ–º hot-reload –æ—Å–Ω–æ–≤–Ω–æ–≥–æ nginx..."
    cd ..
    
    if docker-compose exec nginx nginx -s reload; then
        echo "‚úÖ Nginx —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ hot-reload"
        echo "üåê HTTPS –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –ø—Ä–æ—Å—Ç–æ—è"
    else
        echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å hot-reload, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫..."
        docker-compose restart nginx
    fi
    
    cd ssl-factory
    
    # –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    echo "$(date '+%Y-%m-%d %H:%M:%S') - SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–ª—è $DOMAIN —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã" >> ./logs/renewal.log
    
    echo ""
    echo "üéâ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
    echo "üìã –°–∞–π—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ HTTPS://$DOMAIN"
    
else
    echo "‚ÑπÔ∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ –ø–æ—Ç—Ä–µ–±–æ–≤–∞–ª–æ—Å—å (—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å)"
    echo "üìã –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã –¥–æ: $EXPIRY_DATE"
fi

echo ""
echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω"
