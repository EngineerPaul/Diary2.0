# SSL Factory

Независимая фабрика для получения и управления SSL сертификатами Let's Encrypt.

## Обзор

SSL Factory - это изолированная система для автоматического получения и обновления SSL сертификатов. Она работает независимо от основного проекта и предоставляет готовые сертификаты для продакшн использования.

## Архитектура

```
ssl-factory/
├── ssl-compose.yaml          # Временная инфраструктура для SSL
├── nginx/
│   ├── Dockerfile            # Временный nginx для верификации
│   └── temp-ssl.conf         # Конфигурация только для верификации
├── certbot/
│   ├── Dockerfile            # Certbot с entrypoint
│   ├── entrypoint.sh         # Скрипт получения/обновления сертификатов
│   └── env.example           # Пример конфигурации
├── _temp_token/              # Временные токены для верификации
├── scripts/
│   ├── setup-ssl.sh          # Первоначальная настройка
│   ├── renew-ssl.sh          # Обновление без остановки
│   ├── get-days-left.sh      # Проверка срока действия
│   ├── backup-ssl.sh         # Резервное копирование
│   └── check-expiry.sh       # Проверка с уведомлениями
├── letsencrypt/              # Хранилище сертификатов Let's Encrypt
├── logs/                     # Логи обновлений
├── help.txt                  # Краткая инструкция
└── README.md                 # Этот файл
```

## Принцип работы

### Первоначальная настройка
1. **Проверяет доступность домена** (независимо от основного проекта)
2. **Требует свободный порт 80** (проверяет и сообщает пользователю)
3. **Запускает временную инфраструктуру** для верификации домена
4. **Получает сертификаты** от Let's Encrypt
5. **Останавливает временную инфраструктуру**
6. **Пользователь вручную включает HTTPS** в основном проекте

### Обновление сертификатов
1. **Запускается без остановки основного проекта**
2. **Использует API Let's Encrypt** (без HTTP верификации)
3. **Обновляет сертификаты** при необходимости
4. **Выполняет hot-reload nginx** без простоя

## Быстрый старт

### 1. Настройка

```bash
# Создайте конфигурацию
cp certbot/env.example certbot/.env

# Отредактируйте certbot/.env
DOMAIN=your-domain.com
EMAIL=your-email@example.com
# CERTBOT_MODE=production  # Раскомментируйте для реальных сертификатов
```

### 2. Первоначальная настройка

```bash
# Сначала остановите основной проект (освободите порт 80)
docker-compose down

# Запустите первоначальную настройку
./scripts/setup-ssl.sh
```

**Важно:** Требует свободный порт 80! SSL Factory полностью независима.

### 3. Включение HTTPS в основном проекте

```bash
# Включите HTTPS в docker-compose.yaml:
# 1. Раскомментируйте порт 443: - 443:443
# 2. Раскомментируйте SSL том: - ./nginx/ssl:/etc/nginx/ssl:ro
# 3. Раскомментируйте production конфигурацию (и другие настройки в коде, наприемр secure у cookie)

# Запустите основной проект
docker-compose up -d
```

### 4. Автоматическое обновление

```bash
# Добавьте в cron для ежедневной проверки
crontab -e

# Добавьте строку:
0 3 * * * /var/www/Diary-project/Diary2.0/ssl-factory/scripts/renew-ssl.sh >> /var/log/ssl-renewal.log 2>&1
```

## Скрипты управления

### setup-ssl.sh
Первоначальная настройка SSL сертификатов.
- **Требует свободный порт 80** (независим от основного проекта)
- **Проверяет доступность домена** перед запуском
- **Результат:** Сертификаты готовы к использованию в `../nginx/ssl/`

```bash
./scripts/setup-ssl.sh
```

### renew-ssl.sh
Обновление сертификатов без простоя.
- **Работает без остановки продакшена**
- **Автоматическая проверка срока действия**
- **Hot-reload nginx**

```bash
./scripts/renew-ssl.sh
```

### check-expiry.sh
Проверка срока действия с уведомлениями.
- **Показывает детальную информацию**
- **Предупреждения о необходимости обновления**
- **Критические оповещения**

```bash
./scripts/check-expiry.sh
```

### Другие скрипты

- `get-days-left.sh` - возвращает количество дней до истечения
- `backup-ssl.sh` - ручное резервное копирование

## Режимы работы

### Staging режим (по умолчанию)
- **Тестовые сертификаты** Let's Encrypt
- **Нет лимитов** на количество запросов
- **Красный замок** в браузере
- **Идеально для отладки**

### Production режим
- **Реальные сертификаты** Let's Encrypt
- **Доверяют все браузеры** (зеленый замок)
- **Есть лимиты:** 5 сертификатов на домен в час
- **Только для продакшена**

## Переключение режимов

Отредактируйте `certbot/.env`:

```bash
# Для тестирования:
CERTBOT_MODE=staging

# Для продакшена:
CERTBOT_MODE=production
```

## Требования

### Системные требования
- Docker и Docker Compose
- Открытый порт 80 (для первоначальной настройки)
- Открытый порт 443 (для HTTPS в продакшене)
- Права на управление Docker

### Требования к домену
- Домен должен указывать на IP сервера
- Порт 80 должен быть доступен извне
- DNS A-запись настроена правильно

## Безопасность

### Хранение сертификатов
- **Приватный ключ** с правами 600 (только root)
- **Сертификат** с правами 644 (чтение для всех)
- **Автоматические бэкапы** перед обновлением
- **Изолированная файловая система**

### Мониторинг
- **Логирование всех операций**
- **Проверка срока действия**
- **Уведомления об истечении**
- **История обновлений**

## Устранение проблем

### Ошибка: Domain не доступен
```bash
# Проверьте DNS
nslookup your-domain.com

# Проверьте порт 80
telnet your-server-ip 80

# Проверьте nginx
docker-compose ps nginx
```

### Ошибка: Сертификаты не найдены
```bash
# Проверьте папку
ls -la ../nginx/ssl/

# Проверьте права
ls -la ../nginx/ssl/cert.pem
```

### Ошибка: Nginx не запускается с SSL
```bash
# Проверьте конфигурацию
docker-compose exec nginx nginx -t

# Проверьте логи
docker-compose logs nginx
```

## Резервное копирование

### Автоматические бэкапы
Бэкапы создаются автоматически перед каждым обновлением:
```bash
../nginx/ssl/backup/20240129_153022/
├── cert.pem
├── key.pem
└── ...
```

### Ручное резервирование
```bash
./scripts/backup-ssl.sh
```

### Восстановление
```bash
# Найдите нужный бэкап
ls ../nginx/ssl/backup/

# Восстановите
cp ../nginx/ssl/backup/20240129_153022/* ../nginx/ssl/
```

## Интеграция с другими проектами

SSL Factory может быть использована в любом проекте:

```bash
# Скопируйте SSL Factory
cp -r ssl-factory /path/to/other-project/

# Настройте домен
cd /path/to/other-project/ssl-factory
cp certbot/env.example certbot/.env
# Отредактируйте certbot/.env

# Запустите настройку
./scripts/setup-ssl.sh
```

## Поддержка

### Логи
- **Логи SSL Factory:** `ssl-factory/logs/`
- **Логи Docker:** `docker-compose logs`
- **Логи обновлений:** `/var/log/ssl-renewal.log`

### Краткая инструкция
- **Быстрый старт:** `help.txt` - краткая инструкция по использованию

### Полезные команды
```bash
# Проверить статус SSL
./scripts/check-expiry.sh

# Проверить дни до истечения
./scripts/get-days-left.sh

# Ручное обновление
./scripts/renew-ssl.sh

# Проверить логи
tail -f /var/log/ssl-renewal.log
```

## Лицензия

Этот проект является частью Diary2.0 и следует той же лицензии.

---

**Важно:** Всегда тестируйте в staging режиме перед переключением в production!
